# AI Studio—Repeat Buyer predict

## 项目说明

智能营销工具可以帮助商家预测用户购买的行为，比赛提供了一段时间内品牌商家的历史订单数据，目的在于构建一个 **预测模型**，预估用户人群在规定时间内产生购买行为的概率。

模型构建成功以后可应用于各种电商数据分析，以及各类电商平台， 不仅可以帮助商家基于平台流量，进行商品售卖、支付，还可以通过MarTech技术更精准地锁定核心用户，对用户的购买行为进行预测。

## 数据和比赛资料

[**比赛链接**](https://aistudio.baidu.com/aistudio/competition/detail/21)

[**比赛数据**](https://aistudio.baidu.com/aistudio/datasetdetail/19383)

比赛方提供了一段时间内某电商平台的订单数据，并对数据进行了模拟生成，对某些特征含义进行了隐藏，进行了脱敏处理。

比赛并未给出完整的训练集和测试集，需要从订单数据集中抽取特征并自行构建。

比赛的Round1阶段目标是预测下个月用户是否购买，Round2阶段是预测下下个月用户是否购买。

比赛的评分方式为：

带权的交叉熵：
$$
logloss = -\frac{1}{N}\sum_{i=1}^{N}(y_{i}*log(p_{i})*\delta +(1-y_{i})*log(1-p_{i}))
$$
其中N表示测试集样本数量，yi表示测试集中第i个样本的真实标签，pi表示第 i个样本的预估转化率，δ为惩罚系数。

本次评分采用score值，得分将按照从高到低排序，公式如下:
$$
score=100-(logloss-0.60)x100
$$


## 解题思路

比赛需要自行构造训练集和测试集，并选取特征。

**构造训练集和测试集：**

* 由数据集的简单分析可知，订单发生的时间最晚的时间为13年8月31日，即要预测用户在九月是否购买，首先筛选出所有有过购买行为的用户(custormer_id)，并根据用户id来提取特征，主要包括商品特征，用户特征，时间特征等；然后根据购买时间来筛选出在7月30号之前购买的用户，若在8月份该用户发生了购买行为，即发生了重复购买，为其打上标签为1，若并未在8月购买，即未重复购买，其标签为0。

* 相比训练集，测试集构造较为简单，即包含数据集中所有的用户，并提取特征，提取特征的方法与训练集一样。

**特征工程：**

首先要对数据集进行清洗，去除缺失值、重复值等，然后对用户id进行特征提取，主要从三个方面考虑：

（1）商品特征，即订单中的商品信息，包括所有订单的商品种类，商品单价，商品数量，上架时间和下架时间，订单总价，包括其均值，最大值，标准差等；

（2）用户特征，即用户的性别，城市，评价次数，会员状态等，以及RFM指标，即最近一次订单的时间、购买的总次数、统计时间内的消费金额；

（3）时间特征，包括用户不同订单的时间间隔，最后订单时间划分，

**模型训练与预测：**

选择合适的模型，以**Xgboost**模型为主，将构造好的训练集进行训练，并预测，后续采用多个模型，包括**catboost、Lightboost**等，来进行模型融合，**模型融合方式为Stacking**。

## 实现过程

### 1、环境以及依赖库配置

* Python==3.7.1
* scikit-learn==0.21.2
* pandas==0.24.2
* numpy==1.18.2
* Xgboost==0.90
* Catboost==0.20.2
* Lightgbm==2.31
* tensorflow==1.13.1
* deepctr==0.7.2 

### 2、文件说明

(1)data_process.py—对原始数据集进行预处理，包括缺失值填充，数据划分，异常值处理等，然后构造训练集和测试集，并进行特征提取；

(2)xgb_model.py—首先离散数据进行label-encoder，采用xgboost来进行训练和预测，并进行参数调整，调参过程并未代码中体现，采用GradSerchCV训练周期较长，并未使用全量数据集，并且训练集正负样本不均衡，酌情增加了正样本的比例；

(3)model_stacking.py—采用stacking的方式来进行模型融合，以xgboost、lightgbm、catboost为主，采用五折交叉验证，模型融合训练时间较长；

(4)deeFM_model.py—尝试采用深度模型来进行训练，采用deepctr库的deepFM模型，可以实现二阶和高阶特征组合，训练时间较长，由于正负样本偏差较大，模型很容易过拟合，预测结果并未有提高。

### 3、关键提分点

* 采用RFM模型方法来对用户进行区分，可将用户大致分为八个类别，并以此来判断用户的价值，也能很好地反应出用户的不同行为，从而更好对用户进行预测；
* 采用自定义损失函数，由于数据正负样本不均衡，比赛的评分方式采用带权的交叉熵，因此在训练过程中自定了带权重（即惩罚因子）的损失函数，并将惩罚因子作为超参数来进行调整。

### 4、总结与思考

最终排名第7名，通过本次比赛，进一步加深了对数据和算法模型的理解，尤其是针对业务场景，对数据进行充分的挖掘，可以使算法模型有很好的提升，但与第一名仍然有不小差距，还有很大的提升空间。

本次比赛赛题有些类似于CTR预估，但CTR预估更多考虑对指定item的预测，而本赛题只预测用户是否会发生购买，并且由于大量用户只有一次购买记录，在构建特征过程当中并未考虑用户与商品之间的交互行为，因此若要进一步提升预测效果，可从以下方面入手：

* 可采用Embedding策略，运用word2vec的方法来构建用户Embedding向量和商品embedding向量，可根据embedding向量的相似度，来进一步划分用户和商品，之后在采用分类算法模型来预测用户是否购买；
* 考虑用户的历史行为，对用户embedding和商品embedding向量之间进行组合特征，可采用深度学习网络强大的特征组合和学习能力，来对特征进行组合交叉，可以采用的模型有Wide&Deep、DCN网络、xDeepFM等CTR预估模型，深度学习模型可以进一步挖掘特征之间的潜在关系。

   
